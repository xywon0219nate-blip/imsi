<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FindMyRide - ë‚˜ë§Œì˜ ì‘ì€ ìˆ²</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet" />
    <style>
        /* (ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ê³¼ ë™ì¼í•©ë‹ˆë‹¤. í¸ì˜ìƒ ì¤„ì—¬ë‘¡ë‹ˆë‹¤.) */
        :root { --main-blue: #457b9d; --bg-color: #fafafa; --tree-green: #2ecc71; }
        body { background-color: var(--bg-color); font-family: 'Pretendard', sans-serif; display: flex; flex-direction: column; min-height: 100vh; margin: 0; }
        
        header { background: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 800; font-size: 1.2rem; }
        
        /* ë¡œê·¸ì¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #login-btn { background: #4285F4; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #user-info { display: none; font-size: 14px; }
        #logout-link { color: #999; text-decoration: underline; cursor: pointer; margin-left: 10px; font-size: 12px; }

        .dashboard-container { max-width: 800px; margin: 20px auto; width: 90%; text-align: center; }
        .tree-section { background: white; padding: 40px; border-radius: 20px; margin-bottom: 20px; }
        #tree-display { font-size: 100px; margin: 20px 0; display: block; }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 15px; border-radius: 10px; border: 1px solid #ddd; background: white; cursor: pointer; }
        button:hover { background: #f0f9ff; }
    </style>
</head>
<body>

    <header>
        <div class="logo">FindMyRide</div>
        <div>
            <button id="login-btn">G êµ¬ê¸€ ë¡œê·¸ì¸</button>
            <div id="user-info">
                <span id="user-name"></span>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!
                <span id="logout-link">ë¡œê·¸ì•„ì›ƒ</span>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <section class="tree-section">
            <div>ì˜¤ëŠ˜ ì¤„ì¸ íƒ„ì†Œ: <strong id="score">0</strong>g</div>
            <div id="tree-display">ğŸŒ±</div>
            <h3 id="level-name">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
            <p style="color:#888; font-size:14px;">ë¡œê·¸ì¸í•˜ë©´ ë‚´ ë‚˜ë¬´ê°€ ì €ì¥ë¼ìš”!</p>
        </section>

        <div class="action-grid">
            <button onclick="addPoints(50)">ğŸ¥¤ í…€ë¸”ëŸ¬ (+50g)</button>
            <button onclick="addPoints(200)">ğŸšŒ ëŒ€ì¤‘êµí†µ (+200g)</button>
            <button onclick="alert('ì¤€ë¹„ì¤‘')">ğŸš² ë”°ë¦‰ì´ ì§€ë„</button>
            <button onclick="resetData()">ğŸ”„ ì´ˆê¸°í™”</button>
        </div>
    </div>

    <script type="module">
        // 1. íŒŒì´ì–´ë² ì´ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°€ì ¸ì˜¤ê¸° (CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. â˜…ì—¬ê¸°ì— ì•„ê¹Œ ë©”ëª¨ì¥ì— ë³µì‚¬í•œ ë‚´ ì•± ì •ë³´ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!â˜…
        // (apiKeyë¶€í„° appIdê¹Œì§€ ìˆëŠ” ë¶€ë¶„)
        const firebaseConfig = {
Â          apiKey: "AIzaSyD26IjJXt-2N85EXKHBsxMnRyVgQ-ODByY",
Â          authDomain: "capstone-a39ed.firebaseapp.com",
Â          projectId: "capstone-a39ed",
Â          storageBucket: "capstone-a39ed.firebasestorage.app",
Â          messagingSenderId: "522941456140",
Â          appId: "1:522941456140:web:fe8095ecfc82bd756d3329"
        };


        // 3. íŒŒì´ì–´ë² ì´ìŠ¤ ì‹¤í–‰
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); // ë¡œê·¸ì¸ ë‹´ë‹¹
        const db = getFirestore(app); // ë°ì´í„°ë² ì´ìŠ¤ ë‹´ë‹¹
        const provider = new GoogleAuthProvider(); // êµ¬ê¸€ ë¡œê·¸ì¸ ë„êµ¬

        // ì „ì—­ ë³€ìˆ˜ (ë‚´ ì ìˆ˜)
        let myScore = 0;
        let myUid = null; // ë‚˜ì˜ ê³ ìœ  ID

        // --- ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ---
        document.getElementById('login-btn').addEventListener('click', () => {
            signInWithPopup(auth, provider)
                .then((result) => {
                    console.log("ë¡œê·¸ì¸ ì„±ê³µ!", result.user);
                }).catch((error) => {
                    console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨", error);
                });
        });

        // --- ë¡œê·¸ì•„ì›ƒ í´ë¦­ ì‹œ ---
        document.getElementById('logout-link').addEventListener('click', () => {
            signOut(auth).then(() => {
                alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
            });
        });

        // --- ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€ (í•µì‹¬!) ---
        // ì›¹ì‚¬ì´íŠ¸ì— ë“¤ì–´ì™”ì„ ë•Œ, ì´ ì‚¬ëŒì´ ë¡œê·¸ì¸í•œ ìƒíƒœì¸ì§€ í™•ì¸
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // ë¡œê·¸ì¸ ëœ ìƒíƒœ
                myUid = user.uid; // ë‚´ ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ ê°™ì€ ê³ ìœ  ID
                
                // í™”ë©´ ë°”ê¾¸ê¸°
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('user-info').style.display = 'block';
                document.getElementById('user-name').innerText = user.displayName;

                // DBì—ì„œ ë‚´ ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
                await loadMyData();
            } else {
                // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
                document.getElementById('level-name').innerText = "ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”";
            }
        });

        // --- ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ ---
        async function loadMyData() {
            // 'users'ë¼ëŠ” í´ë” ì•ˆì—ì„œ 'ë‚´ ID'ë¡œ ëœ ë¬¸ì„œë¥¼ ì°¾ìŒ
            const docRef = doc(db, "users", myUid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                // ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê°€ì ¸ì™€ì„œ í™”ë©´ì— ë³´ì—¬ì¤Œ
                myScore = docSnap.data().totalScore;
                updateUI();
            } else {
                // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ (ì²« ë°©ë¬¸) ìƒˆë¡œ ë§Œë“¦
                await setDoc(docRef, {
                    name: auth.currentUser.displayName,
                    totalScore: 0
                });
                myScore = 0;
                updateUI();
            }
        }

        // --- ì ìˆ˜ ì¶”ê°€ í•¨ìˆ˜ (HTML ë²„íŠ¼ì—ì„œ í˜¸ì¶œ) ---
        // type="module"ì—ì„œëŠ” í•¨ìˆ˜ë¥¼ windowì— ë¶™ì—¬ì¤˜ì•¼ HTMLì—ì„œ onclickìœ¼ë¡œ ì“¸ ìˆ˜ ìˆìŒ
        window.addPoints = async function(points) {
            if (!myUid) {
                alert("ë¡œê·¸ì¸ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”!");
                return;
            }

            // 1. í™”ë©´ ë¨¼ì € ì—…ë°ì´íŠ¸ (ë¹ ë¥¸ ë°˜ì‘)
            myScore += points;
            updateUI();

            // 2. ì„œë²„ì— ì €ì¥
            const docRef = doc(db, "users", myUid);
            await updateDoc(docRef, {
                totalScore: increment(points) // ê¸°ì¡´ ì ìˆ˜ì— ë”í•˜ê¸°
            });
        }

        window.resetData = async function() {
            if (!myUid) return;
            if(confirm("ì •ë§ ì´ˆê¸°í™” í• ê¹Œìš”?")) {
                const docRef = doc(db, "users", myUid);
                await setDoc(docRef, { totalScore: 0 }, { merge: true });
                myScore = 0;
                updateUI();
            }
        }

        // --- í™”ë©´ ê·¸ë¦¬ê¸° ---
        function updateUI() {
            document.getElementById('score').innerText = myScore;
            
            const tree = document.getElementById('tree-display');
            const label = document.getElementById('level-name');

            if(myScore < 100) { tree.innerText = "ğŸŒ±"; label.innerText = "ë ˆë²¨1. ìƒˆì‹¹"; }
            else if(myScore < 500) { tree.innerText = "ğŸŒ¿"; label.innerText = "ë ˆë²¨2. ë¬˜ëª©"; }
            else { tree.innerText = "ğŸŒ³"; label.innerText = "ë ˆë²¨3. ë‚˜ë¬´"; }
        }
    </script>
</body>
</html>
