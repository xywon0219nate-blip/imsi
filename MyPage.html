<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë§ˆì´í˜ì´ì§€ | FindMyRide</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet" />
  <style>
    :root {
      --main-blue: #457b9d;
      --light-blue: #a8dadc;
      --dark-blue: #1d3557;
      --bg-color: #f8fafc;
      --card-bg: #ffffff;
      --text-gray: #64748b;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
    body { background-color: var(--bg-color); color: var(--dark-blue); }

    /* í—¤ë” */
    header {
      width: 100%; background: #fff; display: flex; align-items: center; justify-content: space-between;
      padding: 15px 30px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000;
    }
    .logo { font-weight: 800; font-size: 1.5rem; color: var(--dark-blue); text-decoration: none; z-index: 1002; margin-right: auto; }
    
    .nav-links { display: flex; gap: 30px; list-style: none; margin: 0; padding: 0; position: absolute; left: 50%; transform: translateX(-50%); }
    .nav-links a { text-decoration: none; color: var(--dark-blue); font-weight: 600; font-size: 16px; transition: color 0.2s; }
    .nav-links a:hover, .nav-links a.active { color: var(--main-blue); }

    .hamburger { display: none; cursor: pointer; font-size: 24px; color: var(--dark-blue); z-index: 1002; background: none; border: none; padding: 5px; }

    @media (max-width: 768px) {
        header { padding: 15px 20px; }
        .nav-links { 
            position: fixed; top: 0; right: -100%; left: auto; transform: none;
            height: 100vh; width: 250px; background-color: white; 
            flex-direction: column; align-items: flex-start;
            padding: 80px 30px; gap: 25px; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s ease-in-out; z-index: 1001;
        }
        .nav-links.active { right: 0; }
        .hamburger { display: block; margin-left: auto; }
    }

    .mypage-container {
      max-width: 800px; margin: 40px auto; width: 95%;
      display: flex; flex-direction: column; gap: 30px;
    }

    /* í”„ë¡œí•„ ì¹´ë“œ */
    .profile-card {
      background: var(--card-bg); border-radius: 20px; padding: 40px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.03); display: flex; align-items: center; gap: 30px; position: relative;
    }
    .profile-img-wrapper { position: relative; width: 100px; height: 100px; }
    .profile-img {
      width: 100%; height: 100%; border-radius: 50%;
      background-color: var(--light-blue); object-fit: cover;
      display: flex; justify-content: center; align-items: center;
      font-size: 36px; color: white; font-weight: bold; overflow: hidden;
    }
    .edit-icon {
        position: absolute; bottom: 0; right: 0;
        background: var(--dark-blue); color: white;
        width: 30px; height: 30px; border-radius: 50%;
        display: flex; justify-content: center; align-items: center;
        font-size: 14px; cursor: pointer; border: 2px solid white;
    }
    .profile-info h2 { font-size: 24px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
    .level-badge { font-size: 12px; background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 12px; font-weight: bold; }
    .profile-info p { font-size: 14px; color: var(--text-gray); }
    #file-input { display: none; }

    /* í†µê³„ ëŒ€ì‹œë³´ë“œ */
    .section-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; }
    .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    .stat-card {
      background: var(--card-bg); padding: 25px; border-radius: 16px;
      text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.03); transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-icon { font-size: 32px; margin-bottom: 10px; display: block; }
    .stat-label { color: var(--text-gray); font-size: 14px; margin-bottom: 5px; }
    .stat-value { font-size: 24px; font-weight: 800; color: var(--dark-blue); }
    .stat-unit { font-size: 14px; font-weight: normal; color: var(--text-gray); }

    /* ì¦ê²¨ì°¾ê¸° ì„¹ì…˜ */
    .favorites-group { margin-bottom: 30px; }
    .sub-title { font-size: 16px; font-weight: bold; color: var(--main-blue); margin-bottom: 10px; display: block; }
    
    .favorites-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
    
    .fav-item {
      background: var(--card-bg); padding: 20px; border-radius: 12px;
      display: flex; justify-content: space-between; align-items: center;
      border: 1px solid #f1f5f9; transition: all 0.2s;
    }
    .fav-item:hover { border-color: var(--main-blue); background: #f8fbff; }
    .fav-name { font-weight: bold; font-size: 16px; margin-bottom: 4px; }
    .fav-sub { font-size: 13px; color: var(--text-gray); }
    .del-btn {
      background: #fee2e2; color: #ef4444; border: none; padding: 6px 12px;
      border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer;
    }
    .del-btn:hover { background: #fecaca; }
    
    .empty-msg {
        text-align: center; padding: 20px; color: #94a3b8; font-size: 14px;
        background: #f8fafb; border-radius: 12px; border: 2px dashed #e2e8f0; width: 100%;
    }

    footer { background: var(--dark-blue); color: white; text-align: center; padding: 50px 20px; margin-top: 80px; }
    
    @media (max-width: 768px) {
        .profile-card { flex-direction: column; text-align: center; }
        .dashboard-grid { grid-template-columns: 1fr; }
        .favorites-list { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <header>
    <a href="Index.html" class="logo">FindMyRide</a>
    <ul class="nav-links" id="nav-links">
      <li><a href="Index.html">í™ˆ</a></li>
      <li><a href="test2.html">ëŒ€ì—¬ì†Œ ì°¾ê¸°</a></li>
      <li><a href="r_map.html">ì¬í™œìš© ì§€ë„</a></li>
      <li><a href="MyPage.html" class="active">ë§ˆì´í˜ì´ì§€</a></li>
      <li><a href="Notice.html">ê³µì§€ì‚¬í•­</a></li>
    </ul>
    <button class="hamburger" onclick="toggleMenu()">â˜°</button>
  </header>

  <div class="mypage-container">
    
    <div class="profile-card">
      <div class="profile-img-wrapper">
        <img id="profile-pic" class="profile-img" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="í”„ë¡œí•„">
        <label for="file-input" class="edit-icon">ğŸ“·</label>
        <input type="file" id="file-input" accept="image/*" onchange="changeProfile(this)">
      </div>
      <div class="profile-info">
        <h2><span id="user-name">ë¡œë”© ì¤‘...</span> <span class="level-badge" id="level-badge">ğŸŒ± Lv.1</span></h2>
        <p id="user-email">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
      </div>
    </div>

    <div>
        <div class="section-title">ë‚˜ì˜ í™œë™ ìš”ì•½</div>
        <div class="dashboard-grid">
            <div class="stat-card">
                <span class="stat-icon">ğŸ’°</span>
                <div class="stat-label">ë³´ìœ  í¬ì¸íŠ¸</div>
                <div class="stat-value" id="total-score">0</div>
                <div class="stat-unit">point (g)</div>
            </div>
            <div class="stat-card">
                <span class="stat-icon">ğŸš²</span>
                <div class="stat-label">ëˆ„ì  ìì „ê±° ê±°ë¦¬</div>
                <div class="stat-value" id="bike-dist">0.0</div>
                <div class="stat-unit">km</div>
            </div>
            <div class="stat-card">
                <span class="stat-icon">ğŸ‘Ÿ</span>
                <div class="stat-label">ì˜¤ëŠ˜ì˜ ê±¸ìŒ</div>
                <div class="stat-value" id="today-steps">0</div>
                <div class="stat-unit">steps</div>
            </div>
        </div>
    </div>

    <div class="favorites">
      <div class="section-title">ìì£¼ ê°€ëŠ” ì¥ì†Œ</div>
      
      <div class="favorites-group">
          <span class="sub-title">ğŸš² ë”°ë¦‰ì´ ëŒ€ì—¬ì†Œ <button onclick="location.href='test2.html'" style="font-size:11px; padding:3px 8px; border:1px solid #ddd; background:white; border-radius:5px; cursor:pointer; margin-left:5px;">+ ì¶”ê°€</button></span>
          <div class="favorites-list" id="favList">
            <div class="empty-msg">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
      </div>

      <div class="favorites-group">
          <span class="sub-title">â™»ï¸ ìì› íšŒìˆ˜ ê±°ì  <button onclick="location.href='recycle_map.html'" style="font-size:11px; padding:3px 8px; border:1px solid #ddd; background:white; border-radius:5px; cursor:pointer; margin-left:5px;">+ ì¶”ê°€</button></span>
          <div class="favorites-list" id="recycleFavList">
            <div class="empty-msg">ì¦ê²¨ì°¾ê¸°í•œ íšŒìˆ˜ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
          </div>
      </div>
    </div>

  </div>

  <footer>
    <p>ìº¡ìŠ¤í†¤ë””ìì¸ 4ì°¨ì‚°ì—…í˜ëª… ìœµí•©í”„ë¡œì íŠ¸2</p>
    <p>2300336@student.hywoman.ac.kr</p>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ==========================================
    // [ìˆ˜ì •ë¨] Index.htmlê³¼ ë™ì¼í•œ ì§„ì§œ í‚¤ ì ìš©!
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyD26IjJXt-2N85EXKHBsxMnRyVgQ-ODByY",
        authDomain: "capstone-a39ed.firebaseapp.com",
        projectId: "capstone-a39ed",
        storageBucket: "capstone-a39ed.firebasestorage.app",
        messagingSenderId: "522941456140",
        appId: "1:522941456140:web:fe8095ecfc82bd756d3329"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const SEOUL_API_KEY = '55554254706e757238356a6d44556d';
    const FAV_STORAGE_KEY = 'findmyride_favorites';
    const RECYCLE_FAV_KEY = 'findmyride_recycle_favorites';

    window.toggleMenu = function() {
        const nav = document.getElementById('nav-links');
        const btn = document.querySelector('.hamburger');
        nav.classList.toggle('active');
        btn.innerHTML = nav.classList.contains('active') ? "âœ•" : "â˜°";
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById('user-name').innerText = user.displayName;
            document.getElementById('user-email').innerText = user.email;
            if(user.photoURL) document.getElementById('profile-pic').src = user.photoURL;

            const docRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                const score = data.totalScore || 0;
                
                document.getElementById('total-score').innerText = score.toLocaleString();
                const badge = document.getElementById('level-badge');
                if(score < 100) { badge.innerText = "ğŸŒ± Lv.1 ìƒˆì‹¹"; badge.style.background="#dcfce7"; }
                else if(score < 500) { badge.innerText = "ğŸŒ¿ Lv.2 ë¬˜ëª©"; badge.style.background="#dbeafe"; badge.style.color="#1e40af"; }
                else { badge.innerText = "ğŸŒ³ Lv.3 ë‚˜ë¬´"; badge.style.background="#fef3c7"; badge.style.color="#92400e"; }

                document.getElementById('bike-dist').innerText = (data.totalKm || 0).toFixed(1);
            }

            const today = new Date().toLocaleDateString();
            const savedDate = localStorage.getItem('pedometerDate');
            document.getElementById('today-steps').innerText = (savedDate === today) ? (localStorage.getItem('pedometerSteps') || 0) : 0;

            loadMyFavorites();
            loadRecycleFavorites(); 

        } else {
            // ë¡œê·¸ì¸ ì•ˆ ëœ ìƒíƒœì¼ ë•Œ
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.");
            location.href = 'Index.html';
        }
    });

    window.changeProfile = function(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) { document.getElementById('profile-pic').src = e.target.result; };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 1. ë”°ë¦‰ì´ ì¦ê²¨ì°¾ê¸° ë¡œë“œ
    async function loadMyFavorites() {
        const favListEl = document.getElementById('favList');
        const storedFavs = JSON.parse(localStorage.getItem(FAV_STORAGE_KEY)) || [];

        if (storedFavs.length === 0) {
            favListEl.innerHTML = '<div class="empty-msg">ì¦ê²¨ì°¾ê¸°í•œ ëŒ€ì—¬ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        try {
            const PROXY = "https://api.allorigins.win/raw?url=";
            const apiUrl = `http://openapi.seoul.go.kr:8088/${SEOUL_API_KEY}/json/bikeList/1/1000/`;
            const response = await fetch(`${PROXY}${encodeURIComponent(apiUrl)}`);
            const data = await response.json();
            const allStations = data.rentBikeStatus.row;
            const myStations = allStations.filter(station => storedFavs.includes(station.stationId));

            favListEl.innerHTML = '';
            myStations.forEach(station => {
                const item = document.createElement('div');
                item.className = 'fav-item';
                item.innerHTML = `
                    <div class="fav-info">
                        <div class="fav-name">${station.stationName}</div>
                        <div class="fav-sub">ëŒ€ì—¬ ê°€ëŠ¥: <span style="color:#2ecc71; font-weight:bold">${station.parkingBikeTotCnt}</span>ëŒ€</div>
                    </div>
                    <button class="del-btn" onclick="removeFav('${station.stationId}', this)">ì‚­ì œ</button>
                `;
                favListEl.appendChild(item);
            });
        } catch (e) {
            favListEl.innerHTML = '<div class="empty-msg">ëŒ€ì—¬ì†Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }

    // 2. ìì› íšŒìˆ˜ê¸° ì¦ê²¨ì°¾ê¸° ë¡œë“œ
    function loadRecycleFavorites() {
        const listEl = document.getElementById('recycleFavList');
        const favs = JSON.parse(localStorage.getItem(RECYCLE_FAV_KEY)) || [];

        if (favs.length === 0) {
            listEl.innerHTML = '<div class="empty-msg">ì¦ê²¨ì°¾ê¸°í•œ íšŒìˆ˜ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        listEl.innerHTML = '';
        favs.forEach(place => {
            const item = document.createElement('div');
            item.className = 'fav-item';
            item.innerHTML = `
                <div class="fav-info">
                    <div class="fav-name">${place.place_name}</div>
                    <div class="fav-sub">${place.road_address_name}</div>
                </div>
                <button class="del-btn" onclick="removeRecycleFav('${place.id}', this)">ì‚­ì œ</button>
            `;
            listEl.appendChild(item);
        });
    }

    window.removeFav = function(stationId, btn) {
        if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        let storedFavs = JSON.parse(localStorage.getItem(FAV_STORAGE_KEY)) || [];
        storedFavs = storedFavs.filter(id => id !== stationId);
        localStorage.setItem(FAV_STORAGE_KEY, JSON.stringify(storedFavs));
        btn.parentElement.remove();
        if (storedFavs.length === 0) document.getElementById('favList').innerHTML = '<div class="empty-msg">ì¦ê²¨ì°¾ê¸°í•œ ëŒ€ì—¬ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    window.removeRecycleFav = function(placeId, btn) {
        if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        let favs = JSON.parse(localStorage.getItem(RECYCLE_FAV_KEY)) || [];
        favs = favs.filter(p => p.id !== placeId);
        localStorage.setItem(RECYCLE_FAV_KEY, JSON.stringify(favs));
        btn.parentElement.remove();
        if (favs.length === 0) document.getElementById('recycleFavList').innerHTML = '<div class="empty-msg">ì¦ê²¨ì°¾ê¸°í•œ íšŒìˆ˜ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
  </script>
</body>
</html>
