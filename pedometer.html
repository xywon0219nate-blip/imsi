<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§Œë³´ê¸° - FindMyRide</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet" />
    <style>
        :root { --main-blue: #457b9d; --dark-blue: #1d3557; --bg-color: #fafafa; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
        body { 
            background-color: var(--bg-color); color: var(--dark-blue); 
            display: flex; flex-direction: column; min-height: 100vh; 
            text-align: center;
        }

        header {
            background: #fff; padding: 18px 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            display: flex; justify-content: center; align-items: center; position: relative;
        }
        .back-btn { position: absolute; left: 20px; font-size: 24px; cursor: pointer; }
        .logo { font-weight: 800; font-size: 1.2rem; }

        .container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }

        /* ì›í˜• ê²Œì´ì§€ */
        .circle-container {
            position: relative; width: 250px; height: 250px; margin-bottom: 30px;
        }
        .circle-bg {
            width: 100%; height: 100%; border-radius: 50%;
            border: 15px solid #e2e8f0;
            transition: border-color 0.3s;
        }
        /* ëª©í‘œ ë‹¬ì„± ì‹œ í…Œë‘ë¦¬ ìƒ‰ ë³€ê²½ìš© í´ë˜ìŠ¤ */
        .circle-bg.active { border-color: #22c55e; }

        .step-count-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .step-number { font-size: 60px; font-weight: 800; color: var(--main-blue); line-height: 1; }
        .step-label { font-size: 16px; color: #64748b; margin-top: 5px; }

        .info-text { font-size: 1.1rem; color: #475569; margin-bottom: 40px; line-height: 1.5; }

        button {
            padding: 18px 40px; border-radius: 50px; font-size: 18px; font-weight: bold;
            border: none; cursor: pointer; transition: all 0.2s; width: 100%; max-width: 300px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .start-btn { background: var(--main-blue); color: white; }
        .start-btn:hover { background: #35607a; transform: scale(1.05); }

        .finish-btn { 
            background: #22c55e; color: white; display: none; 
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        .dev-btn {
            margin-top: 20px; background: none; border: none; 
            color: #ccc; font-size: 12px; box-shadow: none; text-decoration: underline;
        }
    </style>
</head>
<body>

    <header>
        <div class="back-btn" onclick="history.back()">â†</div>
        <div class="logo">ë§Œë³´ê¸° ëª¨ë“œ</div>
    </header>

    <div class="container">
        <div class="circle-container">
            <div class="circle-bg" id="circle-border"></div>
            <div class="step-count-box">
                <div class="step-number" id="step-display">0</div>
                <div class="step-label">ê±¸ìŒ</div>
            </div>
        </div>

        <p class="info-text" id="status-msg">
            'ì‹œì‘í•˜ê¸°'ë¥¼ ëˆ„ë¥´ê³ <br>
            ìŠ¤ë§ˆíŠ¸í°ì„ ë“¤ê³  <strong>í˜ì°¨ê²Œ</strong> ê±¸ì–´ë³´ì„¸ìš”!
        </p>

        <button class="start-btn" id="start-btn" onclick="requestPermission()">ì‹œì‘í•˜ê¸°</button>
        <button class="finish-btn" id="finish-btn" onclick="finishWalking()">10g ë°›ê¸° (ì™„ë£Œ)</button>

        <button class="dev-btn" onclick="incrementStep()">[Dev] ê°•ì œ ê±¸ìŒ ì¶”ê°€</button>
    </div>

    <script>
        let stepCount = 0;
        const goalSteps = 30; 
        let isRunning = false;

        // [ê°œì„ ëœ ì•Œê³ ë¦¬ì¦˜ ë³€ìˆ˜]
        let lastStepTime = 0; // ë§ˆì§€ë§‰ ê±¸ìŒì´ ì¸ì‹ëœ ì‹œê°„
        let lastMagnitude = 0;
        
        // 1. ìµœì†Œ ì‹œê°„ ê°„ê²© (ms): ì´ ì‹œê°„ ì•ˆì—ëŠ” ë‘ ë²ˆ ì¹´ìš´íŠ¸í•˜ì§€ ì•ŠìŒ (ì‚¬ëŒì˜ ë¹ ë¥¸ ê±¸ìŒ ê¸°ì¤€)
        const MIN_STEP_DELAY = 400; 
        
        // 2. ë¯¼ê°ë„ ì„¤ì •: ì´ ê°’ë³´ë‹¤ í° ì¶©ê²©ì´ ì™€ì•¼ ê±¸ìŒìœ¼ë¡œ ì¸ì •
        // ê°’ì´ í´ìˆ˜ë¡ ì„¸ê²Œ ê±¸ì–´ì•¼ í•¨ (ë„ˆë¬´ ë‚®ìœ¼ë©´ ì†ë–¨ë¦¼ë„ ì¸ì‹ë¨)
        // ë³´í†µ ê±·ê¸° ê°€ì†ë„ëŠ” 1.2G ~ 1.5G ì •ë„ ë‚˜ì˜µë‹ˆë‹¤.
        const THRESHOLD = 2.7; 

        function requestPermission() {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response == 'granted') {
                            startPedometer();
                        } else {
                            alert("ì„¼ì„œ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
                        }
                    })
                    .catch(console.error);
            } else {
                startPedometer();
            }
        }

        function startPedometer() {
            isRunning = true;
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('status-msg').innerHTML = "ì¸¡ì • ì¤‘...ğŸƒ<br>ê·œì¹™ì ìœ¼ë¡œ ê±¸ì–´ë³´ì„¸ìš”.";
            
            window.addEventListener('devicemotion', handleMotion);
        }

        function handleMotion(event) {
            if (!isRunning) return;

            const acc = event.accelerationIncludingGravity;
            if (!acc) return;

            // X, Y, Z ë²¡í„°ì˜ ì „ì²´ í¬ê¸°(Magnitude) ê³„ì‚°
            // ì´ë ‡ê²Œ í•˜ë©´ í°ì„ ì£¼ë¨¸ë‹ˆì— ë„£ë“  ì†ì— ë“¤ë“  ìƒê´€ì—†ì´ 'í”ë“¤ë¦¼ì˜ ì´ëŸ‰'ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            const magnitude = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);

            // í˜„ì¬ ì‹œê°„
            const currentTime = new Date().getTime();

            // [ì•Œê³ ë¦¬ì¦˜ í•µì‹¬]
            // 1. ë³€í™”ëŸ‰ ê³„ì‚°: ì§€ê¸ˆ í”ë“¤ë¦¼ - ì§ì „ í”ë“¤ë¦¼
            const delta = Math.abs(magnitude - lastMagnitude);

            // 2. ì¡°ê±´ ì²´í¬
            // ì¡°ê±´ A: ë³€í™”ëŸ‰ì´ ì„ê³„ê°’(THRESHOLD)ë³´ë‹¤ ì»¤ì•¼ í•¨ (ì¶©ê²© ê°ì§€)
            // ì¡°ê±´ B: ë§ˆì§€ë§‰ ê±¸ìŒ ì´í›„ ì¼ì • ì‹œê°„(MIN_STEP_DELAY)ì´ ì§€ë‚˜ì•¼ í•¨ (ì¤‘ë³µ ë°©ì§€)
            if (delta > THRESHOLD && (currentTime - lastStepTime > MIN_STEP_DELAY)) {
                incrementStep();
                lastStepTime = currentTime; // ë§ˆì§€ë§‰ ê±¸ìŒ ì‹œê°„ ê°±ì‹ 
            }

            lastMagnitude = magnitude; // í˜„ì¬ ê°’ì„ ì €ì¥í•´ì„œ ë‹¤ìŒ ë¹„êµì— ì‚¬ìš©
        }

        function incrementStep() {
            stepCount++;
            document.getElementById('step-display').innerText = stepCount;

            // ì‹œê°ì  íš¨ê³¼: ê±¸ì„ ë•Œë§ˆë‹¤ ì‚´ì§ ì»¤ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜
            const num = document.getElementById('step-display');
            num.style.transform = "scale(1.2)";
            setTimeout(() => num.style.transform = "scale(1)", 100);

            if (stepCount >= goalSteps) {
                document.getElementById('status-msg').innerHTML = "ğŸ‰ ëª©í‘œ ë‹¬ì„±!<br>í¬ì¸íŠ¸ë¥¼ ë°›ì•„ì£¼ì„¸ìš”.";
                document.getElementById('status-msg').style.color = "#22c55e";
                document.getElementById('status-msg').style.fontWeight = "bold";
                
                document.getElementById('circle-border').classList.add('active');
                
                const finishBtn = document.getElementById('finish-btn');
                finishBtn.style.display = 'block';
                
                window.removeEventListener('devicemotion', handleMotion);
                isRunning = false;
            }
        }

        function finishWalking() {
            localStorage.setItem('walkingSuccess', 'true');
            localStorage.setItem('walkingPoints', '10');
            alert("ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤! ê±´ê°•í•œ ì§€êµ¬ë¥¼ ìœ„í•œ í•œ ê±¸ìŒì´ì—ˆìŠµë‹ˆë‹¤.");
            location.href = 'Index.html';
        }
    </script>
</body>
</html>
