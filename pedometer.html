<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§Œë³´ê¸° - FindMyRide</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet" />
    <style>
        :root { --main-blue: #457b9d; --dark-blue: #1d3557; --bg-color: #fafafa; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
        body { 
            background-color: var(--bg-color); color: var(--dark-blue); 
            display: flex; flex-direction: column; min-height: 100vh; 
            text-align: center;
        }

        header {
            background: #fff; padding: 18px 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            display: flex; justify-content: center; align-items: center; position: relative;
        }
        .back-btn { position: absolute; left: 20px; font-size: 24px; cursor: pointer; }
        .logo { font-weight: 800; font-size: 1.2rem; }

        .container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }

        /* ì›í˜• ê²Œì´ì§€ */
        .circle-container {
            position: relative; width: 250px; height: 250px; margin-bottom: 30px;
        }
        .circle-bg {
            width: 100%; height: 100%; border-radius: 50%;
            border: 15px solid #e2e8f0;
            transition: border-color 0.3s;
        }
        
        /* ë³´ìƒ ê°€ëŠ¥í•  ë•Œ ì´ˆë¡ìƒ‰ */
        .circle-bg.active { border-color: #22c55e; }

        .step-count-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .step-number { font-size: 50px; font-weight: 800; color: var(--main-blue); line-height: 1; }
        .step-label { font-size: 14px; color: #64748b; margin-top: 5px; }
        .next-goal { font-size: 12px; color: #999; margin-top: 5px; }

        .info-text { font-size: 1.1rem; color: #475569; margin-bottom: 40px; line-height: 1.5; }

        button {
            padding: 18px 40px; border-radius: 50px; font-size: 18px; font-weight: bold;
            border: none; cursor: pointer; transition: all 0.2s; width: 100%; max-width: 350px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .start-btn { background: var(--main-blue); color: white; }
        .start-btn:hover { background: #35607a; transform: scale(1.05); }

        /* ë³´ìƒ ë°›ê¸° ë²„íŠ¼ */
        .finish-btn { 
            background: #22c55e; color: white; display: none; 
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        .dev-btn {
            margin-top: 20px; background: none; border: none; 
            color: #ccc; font-size: 12px; box-shadow: none; text-decoration: underline; cursor: pointer;
        }
    </style>
</head>
<body>

    <header>
        <div class="back-btn" onclick="history.back()">â†</div>
        <div class="logo">ë§Œë³´ê¸° ëª¨ë“œ</div>
    </header>

    <div class="container">
        <div class="circle-container">
            <div class="circle-bg" id="circle-border"></div>
            <div class="step-count-box">
                <div class="step-number" id="step-display">0</div>
                <div class="step-label">ì˜¤ëŠ˜ì˜ ê±¸ìŒ</div>
                <div class="next-goal" id="next-goal-text">ë‹¤ìŒ ë³´ìƒê¹Œì§€ 1000</div>
            </div>
        </div>

        <p class="info-text" id="status-msg">
            1,000ê±¸ìŒë§ˆë‹¤ 50g ì ë¦½!<br>
            'ì‹œì‘í•˜ê¸°'ë¥¼ ëˆ„ë¥´ê³  ê±¸ì–´ë³´ì„¸ìš”.
        </p>

        <button class="start-btn" id="start-btn" onclick="requestPermission()">ì´ì–´í•˜ê¸° / ì‹œì‘í•˜ê¸°</button>
        <button class="finish-btn" id="finish-btn" onclick="finishWalking()">í¬ì¸íŠ¸ ë°›ê¸°</button>

        <button class="dev-btn" onclick="incrementStep(100)">[Dev] í…ŒìŠ¤íŠ¸ìš© +100ê±¸ìŒ</button>
    </div>

    <script>
        let totalSteps = 0;
        let isRunning = false;

        // [ì¤‘ìš”] ì˜¤ëŠ˜ ë‚ ì§œ í‚¤ ìƒì„± (ì˜ˆ: "2025. 5. 20.")
        // ì´ ê°’ì´ ë°”ë€Œë©´(ë‹¤ìŒë‚ ì´ ë˜ë©´) ê±¸ìŒ ìˆ˜ë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”í•¨
        const TODAY_KEY = new Date().toLocaleDateString();

        // ì„¼ì„œ ê´€ë ¨ ë³€ìˆ˜
        let lastStepTime = 0;
        let lastMagnitude = 0;
        const MIN_STEP_DELAY = 400; 
        const THRESHOLD = 2.0;      

        // ë³´ìƒ ì„¤ì •
        const STEPS_PER_UNIT = 1000; // 1000ê±¸ìŒ ë‹¨ìœ„
        const POINTS_PER_UNIT = 50;  // 50í¬ì¸íŠ¸

        // [1] í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ê±¸ìŒ ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
        window.onload = function() {
            const savedDate = localStorage.getItem('pedometerDate');
            const savedSteps = localStorage.getItem('pedometerSteps');

            if (savedDate === TODAY_KEY && savedSteps) {
                // ì˜¤ëŠ˜ ë‚ ì§œì™€ ì €ì¥ëœ ë‚ ì§œê°€ ê°™ìœ¼ë©´ -> ì´ì–´ì„œ í•˜ê¸°
                totalSteps = parseInt(savedSteps);
            } else {
                // ë‚ ì§œê°€ ë‹¤ë¥´ë©´(ìƒˆë¡œìš´ í•˜ë£¨) -> 0ìœ¼ë¡œ ì´ˆê¸°í™”
                totalSteps = 0;
                localStorage.setItem('pedometerDate', TODAY_KEY);
                localStorage.setItem('pedometerSteps', 0);
                // ì´ë¯¸ ë°›ì€ ë³´ìƒ ê¸°ë¡ë„ ì´ˆê¸°í™”í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
                // localStorage.removeItem('lastClaimedSteps');
            }

            // í™”ë©´ ê°±ì‹ 
            updateDisplay();
        };

        function requestPermission() {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response == 'granted') {
                            startPedometer();
                        } else {
                            alert("ì„¼ì„œ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
                        }
                    })
                    .catch(console.error);
            } else {
                startPedometer();
            }
        }

        function startPedometer() {
            isRunning = true;
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('status-msg').innerHTML = "ì¸¡ì • ì¤‘...ğŸƒ<br>í™”ë©´ì„ ì¼œë‘ê³  ê±¸ì–´ì£¼ì„¸ìš”.";
            
            window.addEventListener('devicemotion', handleMotion);
        }

        function handleMotion(event) {
            if (!isRunning) return;

            const acc = event.accelerationIncludingGravity;
            if (!acc) return;

            const magnitude = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
            const currentTime = new Date().getTime();
            const delta = Math.abs(magnitude - lastMagnitude);

            if (delta > THRESHOLD && (currentTime - lastStepTime > MIN_STEP_DELAY)) {
                incrementStep(1); 
                lastStepTime = currentTime;
            }

            lastMagnitude = magnitude;
        }

        // ê±¸ìŒ ìˆ˜ ì¦ê°€ í•¨ìˆ˜
        function incrementStep(amount) {
            totalSteps += amount;
            
            // [ì¤‘ìš”] ê±¸ì„ ë•Œë§ˆë‹¤ ì €ì¥í•˜ê¸°
            localStorage.setItem('pedometerSteps', totalSteps);
            localStorage.setItem('pedometerDate', TODAY_KEY);

            updateDisplay();
        }

        // í™”ë©´ ë° ë³´ìƒ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ë¶„ë¦¬ë¨)
        function updateDisplay() {
            document.getElementById('step-display').innerText = totalSteps.toLocaleString();
            
            let remainder = totalSteps % STEPS_PER_UNIT;
            let stepsLeft = STEPS_PER_UNIT - remainder;
            
            // ì´ë¯¸ ë³´ìƒë°›ì€ ê±¸ìŒ ìˆ˜ ì²´í¬ (ì¤‘ë³µ ìˆ˜ë ¹ ë°©ì§€ìš© ë¡œì§ì´ í•„ìš”í•˜ë‹¤ë©´ ì¶”ê°€ êµ¬í˜„ ê°€ëŠ¥)
            // ì—¬ê¸°ì„œëŠ” ì‹¬í”Œí•˜ê²Œ í˜„ì¬ ê±¸ìŒ ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.
            
            let claimableUnits = Math.floor(totalSteps / STEPS_PER_UNIT);
            let claimablePoints = claimableUnits * POINTS_PER_UNIT;

            // ë³´ìƒ ì¡°ê±´: 1000ê±¸ìŒ ì´ìƒì¼ ë•Œ
            if (claimableUnits > 0) {
                document.getElementById('next-goal-text').innerText = "ë³´ìƒ ìˆ˜ë ¹ ê°€ëŠ¥!";
                document.getElementById('next-goal-text').style.color = "#22c55e";
                document.getElementById('next-goal-text').style.fontWeight = "bold";
                document.getElementById('circle-border').classList.add('active');
                
                const btn = document.getElementById('finish-btn');
                btn.style.display = 'block';
                btn.innerText = `ğŸ ${claimablePoints}g ë°›ê¸° (ëˆ„ì  ${totalSteps}ë³´)`;
                
                if(isRunning) {
                    document.getElementById('status-msg').innerHTML = `ì¶•í•˜í•©ë‹ˆë‹¤! <strong>${claimableUnits * 1000}ê±¸ìŒ</strong> ëŒíŒŒ!`;
                }
            } else {
                document.getElementById('next-goal-text').innerText = `ë‹¤ìŒ ë³´ìƒê¹Œì§€ ${stepsLeft}`;
                document.getElementById('next-goal-text').style.color = "#999";
                document.getElementById('circle-border').classList.remove('active');
                document.getElementById('finish-btn').style.display = 'none';
            }
        }

        function finishWalking() {
            let claimableUnits = Math.floor(totalSteps / STEPS_PER_UNIT);
            let points = claimableUnits * POINTS_PER_UNIT;

            if (points > 0) {
                localStorage.setItem('walkingSuccess', 'true');
                localStorage.setItem('walkingPoints', points);
                
                // ë³´ìƒ ë°›ê³  ë‚˜ë©´ ê±¸ìŒ ìˆ˜ë¥¼ ì´ˆê¸°í™”í• ì§€, ìœ ì§€í• ì§€ ê²°ì •í•´ì•¼ í•©ë‹ˆë‹¤.
                // ì—¬ê¸°ì„œëŠ” 'ì˜¤ëŠ˜ì˜ ëˆ„ì  ê±¸ìŒ' ì»¨ì…‰ì´ë¯€ë¡œ ê±¸ìŒ ìˆ˜ëŠ” ìœ ì§€í•˜ë˜,
                // Index.htmlì—ì„œ ì¤‘ë³µ ì§€ê¸‰ì„ ë§‰ëŠ” ë¡œì§ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                // (í˜„ì¬ ë¡œì§ì€ ë°›ì„ ë•Œë§ˆë‹¤ ê³„ì† ì¤ë‹ˆë‹¤. ì‹œì—°ìš©ìœ¼ë¡œëŠ” ì´ê²Œ ë” ì¢‹ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!)
                
                alert(`ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!\nì˜¤ëŠ˜ ì´ ${totalSteps}ê±¸ìŒì„ ê±¸ì–´\n${points}gì„ íšë“í–ˆìŠµë‹ˆë‹¤.`);
                location.href = 'Index.html';
            }
        }
    </script>
</body>
</html>
