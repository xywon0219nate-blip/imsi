<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§Œë³´ê¸° - FindMyRide</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet" />
    <style>
        :root { --main-blue: #457b9d; --dark-blue: #1d3557; --bg-color: #fafafa; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
        body { 
            background-color: var(--bg-color); color: var(--dark-blue); 
            display: flex; flex-direction: column; min-height: 100vh; 
            text-align: center;
        }

        header {
            background: #fff; padding: 18px 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            display: flex; justify-content: center; align-items: center; position: relative;
        }
        .back-btn { position: absolute; left: 20px; font-size: 24px; cursor: pointer; }
        .logo { font-weight: 800; font-size: 1.2rem; }

        .container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }

        /* ì›í˜• ê²Œì´ì§€ */
        .circle-container {
            position: relative; width: 250px; height: 250px; margin-bottom: 30px;
        }
        .circle-bg {
            width: 100%; height: 100%; border-radius: 50%;
            border: 15px solid #e2e8f0;
            transition: border-color 0.3s;
        }
        
        /* 1000ê±¸ìŒ ë‹¬ì„± ê°€ëŠ¥í•  ë•Œ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë°”ë€œ */
        .circle-bg.active { border-color: #22c55e; }

        .step-count-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .step-number { font-size: 50px; font-weight: 800; color: var(--main-blue); line-height: 1; }
        .step-label { font-size: 14px; color: #64748b; margin-top: 5px; }
        .next-goal { font-size: 12px; color: #999; margin-top: 5px; }

        .info-text { font-size: 1.1rem; color: #475569; margin-bottom: 40px; line-height: 1.5; }

        button {
            padding: 18px 40px; border-radius: 50px; font-size: 18px; font-weight: bold;
            border: none; cursor: pointer; transition: all 0.2s; width: 100%; max-width: 350px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .start-btn { background: var(--main-blue); color: white; }
        .start-btn:hover { background: #35607a; transform: scale(1.05); }

        /* ë³´ìƒ ë°›ê¸° ë²„íŠ¼ */
        .finish-btn { 
            background: #22c55e; color: white; display: none; 
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        .dev-btn {
            margin-top: 20px; background: none; border: none; 
            color: #ccc; font-size: 12px; box-shadow: none; text-decoration: underline; cursor: pointer;
        }
    </style>
</head>
<body>

    <header>
        <div class="back-btn" onclick="history.back()">â†</div>
        <div class="logo">ë§Œë³´ê¸° ëª¨ë“œ</div>
    </header>

    <div class="container">
        <div class="circle-container">
            <div class="circle-bg" id="circle-border"></div>
            <div class="step-count-box">
                <div class="step-number" id="step-display">0</div>
                <div class="step-label">ê±¸ìŒ</div>
                <div class="next-goal" id="next-goal-text">ë‹¤ìŒ ë³´ìƒê¹Œì§€ 1000</div>
            </div>
        </div>

        <p class="info-text" id="status-msg">
            1,000ê±¸ìŒë§ˆë‹¤ 50g ì ë¦½!<br>
            'ì‹œì‘í•˜ê¸°'ë¥¼ ëˆ„ë¥´ê³  ê±¸ì–´ë³´ì„¸ìš”.
        </p>

        <button class="start-btn" id="start-btn" onclick="requestPermission()">ì‹œì‘í•˜ê¸°</button>
        <button class="finish-btn" id="finish-btn" onclick="finishWalking()">í¬ì¸íŠ¸ ë°›ê¸°</button>

        <button class="dev-btn" onclick="incrementStep(100)">[Dev] í…ŒìŠ¤íŠ¸ìš© +100ê±¸ìŒ</button>
    </div>

    <script>
        let totalSteps = 0;
        let isRunning = false;

        // ì„¼ì„œ ê°ë„ ì„¤ì • (ê°’ì´ í´ìˆ˜ë¡ ì„¸ê²Œ í”ë“¤ì–´ì•¼ í•¨)
        let lastStepTime = 0;
        let lastMagnitude = 0;
        const MIN_STEP_DELAY = 400; // 0.4ì´ˆ ê°„ê²© ì œí•œ
        const THRESHOLD = 2.0;      // ê°ë„ (ì ë‹¹í•¨)

        // ë³´ìƒ ì„¤ì •
        const STEPS_PER_UNIT = 1000; // 1000ê±¸ìŒ ë‹¨ìœ„
        const POINTS_PER_UNIT = 50;  // 50í¬ì¸íŠ¸

        function requestPermission() {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response == 'granted') {
                            startPedometer();
                        } else {
                            alert("ì„¼ì„œ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
                        }
                    })
                    .catch(console.error);
            } else {
                startPedometer();
            }
        }

        function startPedometer() {
            isRunning = true;
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('status-msg').innerHTML = "ì¸¡ì • ì¤‘...ğŸƒ<br>í™”ë©´ì„ ì¼œë‘ê³  ê±¸ì–´ì£¼ì„¸ìš”.";
            
            window.addEventListener('devicemotion', handleMotion);
        }

        function handleMotion(event) {
            if (!isRunning) return;

            const acc = event.accelerationIncludingGravity;
            if (!acc) return;

            const magnitude = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
            const currentTime = new Date().getTime();
            const delta = Math.abs(magnitude - lastMagnitude);

            if (delta > THRESHOLD && (currentTime - lastStepTime > MIN_STEP_DELAY)) {
                incrementStep(1); // 1ê±¸ìŒ ì¦ê°€
                lastStepTime = currentTime;
            }

            lastMagnitude = magnitude;
        }

        // ê±¸ìŒ ìˆ˜ ì¦ê°€ í•¨ìˆ˜ (amountë§Œí¼ ì¦ê°€)
        function incrementStep(amount) {
            totalSteps += amount;
            
            // í™”ë©´ ì—…ë°ì´íŠ¸
            document.getElementById('step-display').innerText = totalSteps.toLocaleString();
            
            // ë‹¤ìŒ ë³´ìƒê¹Œì§€ ë‚¨ì€ ê±¸ìŒ ê³„ì‚°
            let remainder = totalSteps % STEPS_PER_UNIT;
            let stepsLeft = STEPS_PER_UNIT - remainder;
            
            // ë§Œì•½ ë”± 1000, 2000... ì´ë©´ ë‚¨ì€ ê±¸ìŒì€ 0ì´ ì•„ë‹ˆë¼ 1000ìœ¼ë¡œ í‘œì‹œí•˜ê³  ì‹¶ë‹¤ë©´ ë¡œì§ ì¡°ì • ê°€ëŠ¥í•˜ë‚˜,
            // ì—¬ê¸°ì„œëŠ” 1000ì´ ì°¨ë©´ 'ë³´ìƒ ê°€ëŠ¥' ìƒíƒœê°€ ë˜ë¯€ë¡œ 0ìœ¼ë¡œ ë‘ .
            
            // ë³´ìƒ ê°€ëŠ¥í•œ ì´ í¬ì¸íŠ¸ ê³„ì‚° (ì˜ˆ: 2500ê±¸ìŒ -> 2000ê±¸ìŒì¹˜ì¸ 100í¬ì¸íŠ¸)
            let claimableUnits = Math.floor(totalSteps / STEPS_PER_UNIT);
            let claimablePoints = claimableUnits * POINTS_PER_UNIT;

            if (claimableUnits > 0) {
                // ë³´ìƒ ë°›ì„ ìˆ˜ ìˆìŒ
                document.getElementById('next-goal-text').innerText = "ë³´ìƒ ìˆ˜ë ¹ ê°€ëŠ¥!";
                document.getElementById('next-goal-text').style.color = "#22c55e";
                document.getElementById('next-goal-text').style.fontWeight = "bold";
                
                document.getElementById('circle-border').classList.add('active');
                
                const btn = document.getElementById('finish-btn');
                btn.style.display = 'block';
                btn.innerText = `ğŸ ${claimablePoints}g ë°›ê¸° (í˜„ì¬ ${totalSteps}ê±¸ìŒ)`;
                
                document.getElementById('status-msg').innerHTML = `ì¶•í•˜í•©ë‹ˆë‹¤! <strong>${claimableUnits * 1000}ê±¸ìŒ</strong> ëŒíŒŒ!<br>ë²„íŠ¼ì„ ëˆŒëŸ¬ í¬ì¸íŠ¸ë¥¼ ë°›ìœ¼ì„¸ìš”.`;
            } else {
                // ì•„ì§ 1000ê±¸ìŒ ì•ˆ ë¨
                document.getElementById('next-goal-text').innerText = `ë‹¤ìŒ ë³´ìƒê¹Œì§€ ${stepsLeft}`;
                document.getElementById('next-goal-text').style.color = "#999";
                document.getElementById('circle-border').classList.remove('active');
                document.getElementById('finish-btn').style.display = 'none';
                
                if(isRunning) {
                    document.getElementById('status-msg').innerHTML = "ì¸¡ì • ì¤‘...ğŸƒ<br>í˜ì°¨ê²Œ ê±¸ì–´ë³´ì„¸ìš”!";
                }
            }
        }

        function finishWalking() {
            // ë°›ì„ í¬ì¸íŠ¸ ê³„ì‚°
            let claimableUnits = Math.floor(totalSteps / STEPS_PER_UNIT);
            let points = claimableUnits * POINTS_PER_UNIT;

            if (points > 0) {
                // Index.htmlë¡œ ì „ë‹¬
                localStorage.setItem('walkingSuccess', 'true');
                localStorage.setItem('walkingPoints', points);
                
                alert(`ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!\nì´ ${totalSteps}ê±¸ìŒì„ ê±¸ì–´\n${points}gì„ íšë“í–ˆìŠµë‹ˆë‹¤.`);
                location.href = 'Index.html';
            }
        }
    </script>
</body>
</html>
