<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ìì› íšŒìˆ˜ê¸° ì°¾ê¸° - FindMyRide</title>

  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet" />
  <style>
    :root {
      --main-blue: #457b9d;
      --light-blue: #a8dadc;
      --dark-blue: #1d3557;
      --bg-color: #fafafa;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
    
    body, html { height: 100%; width: 100%; }
    body { background-color: var(--bg-color); color: var(--dark-blue); display: flex; flex-direction: column; }

    /* í—¤ë” */
    header {
      width: 100%; background: #fff; display: flex; align-items: center; justify-content: space-between;
      padding: 15px 30px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); flex-shrink: 0; z-index: 1000;
    }
    .logo { font-weight: 800; font-size: 1.5rem; color: var(--dark-blue); text-decoration: none; z-index: 1002; margin-right: auto; }
    
    .nav-links { display: flex; gap: 30px; list-style: none; margin: 0; padding: 0; position: absolute; left: 50%; transform: translateX(-50%); }
    .nav-links a { text-decoration: none; color: var(--dark-blue); font-weight: 600; font-size: 16px; transition: color 0.2s; }
    .nav-links a:hover { color: var(--main-blue); }

    .hamburger { display: none; cursor: pointer; font-size: 24px; color: var(--dark-blue); z-index: 1002; background: none; border: none; padding: 5px; }

    /* ì§€ë„ ì˜ì—­ */
    .hero { 
        position: relative; flex-grow: 1; width: 100%; min-height: 0;
    }
    #map { width: 100%; height: 100%; }

    /* --- [ì¶”ê°€] ê²€ìƒ‰ì°½ ë””ìì¸ (test2.htmlê³¼ ë™ì¼) --- */
    .search-wrapper {
        position: absolute;
        top: 20px; left: 50%; transform: translateX(-50%);
        z-index: 100;
        width: 90%; max-width: 420px;
    }

    .search-container {
        background: #fff;
        border-radius: 50px;
        padding: 6px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        display: flex; 
        align-items: center;
        justify-content: space-between;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .search-container:focus-within {
        border-color: var(--main-blue);
        box-shadow: 0 6px 20px rgba(69, 123, 157, 0.2);
    }
    
    #keyword {
        flex: 1;
        border: none;
        background: transparent;
        padding: 10px 15px;
        font-size: 16px;
        outline: none;
        min-width: 0;
    }
    
    .search-btn {
        background: var(--main-blue);
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 40px;
        cursor: pointer;
        font-weight: 700;
        font-size: 15px;
        flex-shrink: 0;
        transition: background 0.2s;
        margin-left: 5px;
    }
    .search-btn:hover { background: var(--dark-blue); }

    /* í•„í„° ë²„íŠ¼ (ìœ„ì¹˜ ì¡°ì •: ê²€ìƒ‰ì°½ ì•„ë˜ë¡œ) */
    .category-filters {
        position: absolute; top: 85px; /* ê²€ìƒ‰ì°½ ë†’ì´ë§Œí¼ ë‚´ë¦¼ */
        left: 50%; transform: translateX(-50%);
        z-index: 90; display: flex; gap: 10px; width: auto;
        background: rgba(255,255,255,0.9); padding: 5px; border-radius: 50px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .filter-btn {
        background: white; border: 1px solid #ddd; padding: 8px 16px;
        border-radius: 30px; font-size: 14px; font-weight: 600; cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); white-space: nowrap;
        display: flex; align-items: center; gap: 6px; transition: all 0.2s;
        color: #555;
    }
    .filter-btn:hover { background: #f0f9ff; transform: translateY(-2px); color: var(--main-blue); }
    
    .filter-btn.active {
        background: var(--main-blue); color: white; border-color: var(--main-blue);
        box-shadow: 0 4px 10px rgba(69, 123, 157, 0.3);
    }

    /* ë¡œë”© */
    .loading-message {
      position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
      background: rgba(29, 53, 87, 0.95); padding: 12px 24px;
      border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      font-size: 14px; font-weight: 600; color: white;
      z-index: 15; display: none; white-space: nowrap;
      animation: fadeInUp 0.3s;
    }
    @keyframes fadeInUp { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }

    /* ì˜¤ë²„ë ˆì´ (ë§í’ì„ ) */
    .custom-overlay {
      position: relative; background: white; border-radius: 12px;
      padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      border: 2px solid var(--main-blue); min-width: 220px;
    }
    .custom-overlay::after {
      content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
      border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 10px solid white;
    }
    .overlay-header { 
        border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 8px; 
        display: flex; justify-content: space-between; align-items: center;
    }
    .overlay-title { font-weight: 700; color: var(--dark-blue); font-size: 16px; margin-right: 10px;}
    
    /* ì¦ê²¨ì°¾ê¸° ë³„ ë²„íŠ¼ */
    .fav-btn { background: none; border: none; cursor: pointer; font-size: 20px; color: #ccc; padding: 0; line-height: 1; }
    .fav-btn.active { color: #ffc107; }

    .overlay-addr { font-size: 13px; color: #666; margin-bottom: 10px; line-height: 1.4; }
    .overlay-link { 
        display: block; text-align: center; background: #f0f9ff; color: var(--main-blue);
        text-decoration: none; padding: 8px; border-radius: 8px; font-size: 13px; font-weight: bold;
        transition: background 0.2s;
    }
    .overlay-link:hover { background: #e0f2fe; }

    @media (max-width: 768px) {
        header { padding: 15px 20px; }
        .nav-links { 
            position: fixed; top: 0; right: -100%; left: auto; transform: none;
            height: 100vh; width: 250px; background-color: white; 
            flex-direction: column; align-items: flex-start;
            padding: 80px 30px; gap: 25px; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s ease-in-out; z-index: 1001;
        }
        .nav-links.active { right: 0; }
        .hamburger { display: block; margin-left: auto; }
        .category-filters { width: 90%; justify-content: center; }
        .search-wrapper { width: 95%; }
    }
  </style>
</head>

<body>
  <header>
    <a href="Index.html" class="logo">FindMyRide</a>
    <ul class="nav-links" id="nav-links">
      <li><a href="Index.html">í™ˆ</a></li>
      <li><a href="test2.html">ëŒ€ì—¬ì†Œ ì°¾ê¸°</a></li>
      <li><a href="r_map.html" style="color:var(--main-blue);">ì¬í™œìš© ì§€ë„</a></li>
      <li><a href="MyPage.html">ë§ˆì´í˜ì´ì§€</a></li>
      <li><a href="Notice.html">ê³µì§€ì‚¬í•­</a></li>
    </ul>
    <button class="hamburger" onclick="toggleMenu()">â˜°</button>
  </header>

  <section class="hero">
    <div class="search-wrapper">
        <div class="search-container">
            <input type="text" id="keyword" placeholder="ì¥ì†Œ ê²€ìƒ‰ (ì˜ˆ: ê°•ë‚¨êµ¬ ìˆ˜ê±°í•¨)" 
                   autocomplete="off" onkeypress="if(event.keyCode==13) performSearch();">
            <button class="search-btn" onclick="performSearch()">ê²€ìƒ‰</button>
        </div>
    </div>

    <div class="category-filters">
        <button class="filter-btn active" onclick="changeCategory('ì£¼ë¯¼ì„¼í„°')"><span>ğŸ”‹</span> íê±´ì „ì§€(ì£¼ë¯¼ì„¼í„°)</button>
        <button class="filter-btn" onclick="changeCategory('ì œë¡œì›¨ì´ìŠ¤íŠ¸')"><span>ğŸŒ¿</span> ì œë¡œì›¨ì´ìŠ¤íŠ¸</button>
    </div>

    <div class="loading-message" id="loadingMsg">ğŸ“ ë‚´ ìœ„ì¹˜ë¥¼ ì°¾ëŠ” ì¤‘...</div>
    <div id="map"></div>
  </section>

  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=dbb43de48b1358f249618a62dade6804&libraries=services"></script>

  <script>
    let map, ps, currentOverlay = null;
    let markers = [];
    let currCategory = 'ì£¼ë¯¼ì„¼í„°'; 
    let currentSearchResults = []; 

    const RECYCLE_FAV_KEY = 'findmyride_recycle_favorites';

    function toggleMenu() {
        const nav = document.getElementById('nav-links');
        const btn = document.querySelector('.hamburger');
        nav.classList.toggle('active');
        btn.innerHTML = nav.classList.contains('active') ? "âœ•" : "â˜°";
    }

    window.onload = function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => { initMap(position.coords.latitude, position.coords.longitude); },
                (error) => { console.warn("ìœ„ì¹˜ ê¶Œí•œ ê±°ë¶€ë¨"); initMap(37.5665, 126.9780); }
            );
        } else {
            initMap(37.5665, 126.9780);
        }
    };

    function initMap(lat, lng) {
        const container = document.getElementById('map');
        const options = { center: new kakao.maps.LatLng(lat, lng), level: 5 };
        
        map = new kakao.maps.Map(container, options);
        ps = new kakao.maps.services.Places();

        // ë‚´ ìœ„ì¹˜ ë§ˆì»¤
        const locPosition = new kakao.maps.LatLng(lat, lng);
        const imageSrc = 'https://cdn-icons-png.flaticon.com/512/3177/3177361.png'; 
        const imageSize = new kakao.maps.Size(32, 32);
        const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);
        new kakao.maps.Marker({ map: map, position: locPosition, image: markerImage, title: 'ë‚´ ìœ„ì¹˜' });

        searchPlaces(currCategory);
    }

    // [ë³€ê²½] ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹œ ê²€ìƒ‰ì°½ ì´ˆê¸°í™” ë° ê²€ìƒ‰
    function changeCategory(keyword) {
        currCategory = keyword;
        document.getElementById('keyword').value = ''; // ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
        searchPlaces(keyword);
    }

    // [ì¶”ê°€] í‚¤ì›Œë“œ ì§ì ‘ ê²€ìƒ‰ ê¸°ëŠ¥
    function performSearch() {
        const keyword = document.getElementById('keyword').value.trim();
        if (!keyword) {
            alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }
        // í•„í„° ë²„íŠ¼ ì„ íƒ í•´ì œ
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        searchPlaces(keyword);
    }

    function searchPlaces(keyword) {
        // í•„í„° ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ì¸ ê²½ìš°)
        document.querySelectorAll('.filter-btn').forEach(btn => {
            if(btn.innerText.includes(keyword) || (keyword === 'ì£¼ë¯¼ì„¼í„°' && btn.innerText.includes('íê±´ì „ì§€'))) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        const loading = document.getElementById('loadingMsg');
        loading.style.display = 'block';
        loading.innerText = `'${keyword === 'ì£¼ë¯¼ì„¼í„°' ? 'íê±´ì „ì§€ ìˆ˜ê±°í•¨' : keyword}' ê²€ìƒ‰ ì¤‘...`;

        const center = map.getCenter();
        const options = { location: center, radius: 5000, sort: kakao.maps.services.SortBy.DISTANCE };
        
        // í‚¤ì›Œë“œ ê²€ìƒ‰ ì‹¤í–‰
        ps.keywordSearch(keyword, placesSearchCB, options);
    }

    function placesSearchCB(data, status, pagination) {
        document.getElementById('loadingMsg').style.display = 'none';
        if (status === kakao.maps.services.Status.OK) {
            currentSearchResults = data;
            displayPlaces(data);
        } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
            alert(`ì£¼ë³€ 5km ë‚´ì— ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`);
            removeMarker();
        } else {
            alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    function displayPlaces(places) {
        removeMarker();
        for ( var i=0; i<places.length; i++ ) {
            addMarker(places[i]);
        }
    }

    function addMarker(place) {
        const imageSrc = 'https://cdn-icons-png.flaticon.com/512/2776/2776067.png';
        const imageSize = new kakao.maps.Size(34, 34);
        const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);
        const marker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(place.y, place.x),
            image: markerImage
        });

        kakao.maps.event.addListener(marker, 'click', function() {
            closeOverlay();
            
            // ì¦ê²¨ì°¾ê¸° ì—¬ë¶€ í™•ì¸
            const favs = JSON.parse(localStorage.getItem(RECYCLE_FAV_KEY)) || [];
            const isFav = favs.some(f => f.id === place.id);

            // [ë³€ê²½] x ë²„íŠ¼(ë‹«ê¸° ë²„íŠ¼) HTML ì œê±°
            const content = `
                <div class="custom-overlay">
                    <div class="overlay-header">
                        <span class="overlay-title">${place.place_name}</span>
                        <div style="display:flex; gap:8px;">
                            <button class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFavorite('${place.id}', this)">${isFav ? 'â˜…' : 'â˜†'}</button>
                        </div>
                    </div>
                    <div class="overlay-addr">${place.road_address_name || place.address_name}</div>
                    <a href="${place.place_url}" target="_blank" class="overlay-link">ìƒì„¸ì •ë³´ / ê¸¸ì°¾ê¸°</a>
                </div>
            `;
            const overlay = new kakao.maps.CustomOverlay({
                content: content,
                map: map,
                position: marker.getPosition(),
                yAnchor: 1.45
            });
            overlay.setMap(map);
            window.currentOverlay = overlay;
            map.panTo(marker.getPosition());
        });
        markers.push(marker);
    }

    function removeMarker() {
        for ( var i = 0; i < markers.length; i++ ) { markers[i].setMap(null); }
        markers = [];
        closeOverlay();
    }

    window.closeOverlay = function() {
        if (window.currentOverlay) {
            window.currentOverlay.setMap(null);
            window.currentOverlay = null;
        }
    }

    window.toggleFavorite = function(placeId, btn) {
        const place = currentSearchResults.find(p => p.id === placeId);
        if (!place) return;

        let favs = JSON.parse(localStorage.getItem(RECYCLE_FAV_KEY)) || [];
        const existingIndex = favs.findIndex(f => f.id === placeId);

        if (existingIndex > -1) {
            favs.splice(existingIndex, 1);
            btn.innerHTML = 'â˜†';
            btn.classList.remove('active');
        } else {
            favs.push({
                id: place.id,
                place_name: place.place_name,
                road_address_name: place.road_address_name || place.address_name,
                place_url: place.place_url
            });
            btn.innerHTML = 'â˜…';
            btn.classList.add('active');
        }
        localStorage.setItem(RECYCLE_FAV_KEY, JSON.stringify(favs));
    }
  </script>
</body>
</html>
