<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FindMyRide</title>

  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet" />
  <style>
    :root {
      --main-blue: #457b9d;
      --light-blue: #a8dadc;
      --dark-blue: #1d3557;
      --bg-color: #fafafa;
      --fav-color: #e63946; /* ì¦ê²¨ì°¾ê¸° ìƒ‰ìƒ (ë¹¨ê°•) */
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
    body { background-color: var(--bg-color); color: var(--dark-blue); }

    header {
      width: 100%;
      background: #fff;
      display: flex; justify-content: space-between; align-items: center;
      padding: 18px 80px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      position: sticky; top: 0; z-index: 10;
    }
    .logo { font-weight: 800; font-size: 1.5rem; color: var(--dark-blue); }
    nav a {
      text-decoration: none; color: var(--dark-blue);
      margin-left: 30px; font-weight: 600; transition: color 0.2s;
    }
    nav a:hover { color: var(--main-blue); }

    .hero { background: linear-gradient(120deg, var(--light-blue), var(--main-blue)); color: white; text-align: center; padding: 40px 20px; position: relative; }
    #map { width: 100%; height: 500px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

    .loading-message {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(255,255,255,0.95); padding: 12px 24px;
      border-radius: 25px; box-shadow: 0 3px 10px rgba(0,0,0,0.15);
      font-size: 14px; font-weight: 600; color: var(--dark-blue);
      z-index: 5; display: none;
    }

    /* ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
    .custom-overlay {
      position: relative;
      background: white;
      border-radius: 16px;
      padding: 14px 18px;
      box-shadow: 0 3px 14px rgba(0,0,0,0.25);
      border: 2px solid var(--main-blue);
      min-width: 220px;
      transition: all 0.2s;
    }
    .custom-overlay::after {
      content: '';
      position: absolute;
      bottom: -10px; left: 50%; transform: translateX(-50%);
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 10px solid white;
    }
    
    .overlay-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
    }
    .overlay-title {
      font-weight: 700;
      color: var(--dark-blue);
      font-size: 15px;
      text-align: left;
      margin-right: 10px;
      word-break: keep-all;
    }
    
    /* ì¦ê²¨ì°¾ê¸° ë³„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .fav-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 20px;
        color: #ccc;
        transition: color 0.2s;
        padding: 0;
        line-height: 1;
    }
    .fav-btn.active {
        color: #ffc107; /* ê½‰ ì°¬ ë³„ ìƒ‰ìƒ */
    }
    .fav-btn:hover {
        transform: scale(1.1);
    }

    .overlay-info {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 13px;
    }
    .info-box {
      flex: 1;
      background: #f6f8fa;
      border-radius: 10px;
      padding: 6px 0;
      text-align: center;
    }
    .info-label {
      color: #777;
      font-size: 12px;
    }
    .info-value {
      font-weight: 700;
      font-size: 18px;
      margin-top: 2px;
    }
    .info-value.low { color: #ff5252; }
    .info-value.medium { color: #ffa726; }
    .info-value.high { color: #2ecc71; }

    footer { background:#1d3557; color:white; text-align:center; padding:50px 20px; }
  </style>
</head>

<body>
  <header>
    <div class="logo">FindMyRide</div>
    <nav>
      <a href="Index.html">í™ˆ</a>
      <a href="test2.html">ëŒ€ì—¬ì†Œ ì°¾ê¸°</a>
      <a href="test3_mypage.html">ë§ˆì´í˜ì´ì§€</a>
      <a href="Notice.html">ê³µì§€ì‚¬í•­</a>
      <a href="CS.html">ê³ ê°ì„¼í„°</a>
    </nav>
  </header>

  <section class="hero">
    <div class="loading-message" id="loadingMsg">ğŸš´ ëŒ€ì—¬ì†Œ ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="map"></div>
  </section>

  <footer>
    <p>ìº¡ìŠ¤í†¤ë””ìì¸ 4ì°¨ì‚°ì—…í˜ëª… ìœµí•©í”„ë¡œì íŠ¸2</p>
    <p>2300336@student.hywoman.ac.kr | (82) 123-4567</p>
    <p>í•œì–‘ì—¬ìëŒ€í•™êµ ì†Œí”„íŠ¸ì›¨ì–´ìœµí•©ê³¼</p>
  </footer>

  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=dbb43de48b1358f249618a62dade6804"></script>

  <script>
    let map, userMarker, userCircle, currentOverlay = null;
    const SEOUL_API_KEY = '55554254706e757238356a6d44556d';
    let stationMarkers = []; // ë§ˆì»¤ ê°ì²´ë“¤ì„ ë‹´ì„ ë°°ì—´
    let cachedStationsData = []; // APIì—ì„œ ë°›ì•„ì˜¨ ë°ì´í„°ë¥¼ ì €ì¥í•  ë°°ì—´ (ì¬ë Œë”ë§ìš©)
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤
    const FAV_STORAGE_KEY = 'findmyride_favorites';

    // ì¦ê²¨ì°¾ê¸° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ID ë°°ì—´)
    function getFavorites() {
        const stored = localStorage.getItem(FAV_STORAGE_KEY);
        return stored ? JSON.parse(stored) : [];
    }

    // ì¦ê²¨ì°¾ê¸° ì €ì¥í•˜ê¸°
    function saveFavorites(favArray) {
        localStorage.setItem(FAV_STORAGE_KEY, JSON.stringify(favArray));
    }

    // ì¦ê²¨ì°¾ê¸° í† ê¸€ í•¨ìˆ˜
    function toggleFavorite(stationId) {
        let favorites = getFavorites();
        if (favorites.includes(stationId)) {
            // ì´ë¯¸ ìˆìœ¼ë©´ ì‚­ì œ
            favorites = favorites.filter(id => id !== stationId);
        } else {
            // ì—†ìœ¼ë©´ ì¶”ê°€
            favorites.push(stationId);
        }
        saveFavorites(favorites);
        
        // ë§ˆì»¤ ë° ì˜¤ë²„ë ˆì´ ê°±ì‹ 
        refreshMapMarkers(); 
    }

    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 6371e3;
      const toRad = deg => deg * (Math.PI / 180);
      const Ï†1 = toRad(lat1);
      const Ï†2 = toRad(lat2);
      const Î”Ï† = toRad(lat2 - lat1);
      const Î”Î» = toRad(lng2 - lng1);
      const a = Math.sin(Î”Ï† / 2) ** 2 +
                Math.cos(Ï†1) * Math.cos(Ï†2) *
                Math.sin(Î”Î» / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function initMap(lat, lng) {
      map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(lat, lng),
        level: 5
      });

      const userImage = new kakao.maps.MarkerImage(
        'https://cdn-icons-png.flaticon.com/512/3177/3177361.png', 
        new kakao.maps.Size(40, 40)
      );

      userMarker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(lat, lng),
        map,
        image: userImage,
        zIndex: 10
      });

      userCircle = new kakao.maps.Circle({
        center: new kakao.maps.LatLng(lat, lng),
        radius: 50,
        strokeWeight: 2,
        strokeColor: '#457b9d',
        strokeOpacity: 0.8,
        fillColor: '#a8dadc',
        fillOpacity: 0.3
      });
      userCircle.setMap(map);

      loadBikeStations(lat, lng);
    }

    function updatePosition(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      if (!map) initMap(lat, lng);
      const newPos = new kakao.maps.LatLng(lat, lng);
      userMarker.setPosition(newPos);
      userCircle.setPosition(newPos);
      map.setCenter(newPos);
    }

    function handleError(err) {
      console.error(err);
      initMap(37.5665, 126.9780);
    }

    async function loadBikeStations(userLat, userLng) {
      const loadingMsg = document.getElementById('loadingMsg');
      loadingMsg.style.display = 'block';

      try {
        const PROXY = "https://api.allorigins.win/raw?url=";
        const apiUrl = `http://openapi.seoul.go.kr:8088/${SEOUL_API_KEY}/json/bikeList/1/1000/`;

        const response = await fetch(`${PROXY}${encodeURIComponent(apiUrl)}`);
        const data = await response.json();
        const stations = data.rentBikeStatus.row;

        // ê±°ë¦¬ ê³„ì‚° ë° ì •ë ¬
        cachedStationsData = stations.map(station => {
          const distance = getDistance(
            userLat, userLng,
            parseFloat(station.stationLatitude),
            parseFloat(station.stationLongitude)
          );
          return { ...station, distance };
        }).sort((a, b) => a.distance - b.distance).slice(0, 10);

        // ë§ˆì»¤ ê·¸ë¦¬ê¸°
        refreshMapMarkers();

        loadingMsg.style.display = 'none';
      } catch (e) {
        console.error('ëŒ€ì—¬ì†Œ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', e);
        loadingMsg.textContent = 'âš ï¸ ëŒ€ì—¬ì†Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
        setTimeout(() => (loadingMsg.style.display = 'none'), 3000);
      }
    }

    // ë§ˆì»¤ë¥¼ ì „ë¶€ ì§€ìš°ê³  ìƒˆë¡œ ê·¸ë¦¬ëŠ” í•¨ìˆ˜ (ì¦ê²¨ì°¾ê¸° ìƒíƒœ ë³€ê²½ ì‹œ í˜¸ì¶œ)
    function refreshMapMarkers() {
        // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
        stationMarkers.forEach(m => m.setMap(null));
        stationMarkers = [];

        // ì˜¤ë²„ë ˆì´ê°€ ì—´ë ¤ìˆë‹¤ë©´ ë‹«ì•„ì¤Œ (ìƒíƒœ ê°±ì‹ ì„ ìœ„í•´)
        if (currentOverlay) currentOverlay.setMap(null);

        // ìºì‹œëœ ë°ì´í„°ë¡œ ë‹¤ì‹œ ê·¸ë¦¼
        cachedStationsData.forEach(station => createStationMarker(station));
    }

    function createStationMarker(station) {
      const pos = new kakao.maps.LatLng(station.stationLatitude, station.stationLongitude);
      const favorites = getFavorites();
      const isFav = favorites.includes(station.stationId); // stationId ê¸°ì¤€ íŒë‹¨

      // ì•„ì´ì½˜ ë¶„ê¸° ì²˜ë¦¬ (ì¦ê²¨ì°¾ê¸°: ë¹¨ê°„ í•€, ì¼ë°˜: íŒŒë€ í•€)
      const normalIconUrl = "https://cdn-icons-png.flaticon.com/512/2776/2776067.png"; // íŒŒë€ìƒ‰
      const favIconUrl = "https://cdn-icons-png.flaticon.com/512/2776/2776063.png"; // ë¹¨ê°„ìƒ‰
      
      const iconUrl = isFav ? favIconUrl : normalIconUrl;
      const markerImage = new kakao.maps.MarkerImage(iconUrl, new kakao.maps.Size(34, 34));

      const marker = new kakao.maps.Marker({ position: pos, map, image: markerImage });
      
      // í´ë¦­ ì‹œ ì˜¤ë²„ë ˆì´ í‘œì‹œ
      kakao.maps.event.addListener(marker, 'click', () => showStationInfo(station, marker));
      stationMarkers.push(marker);
    }

    function showStationInfo(station, marker) {
      if (currentOverlay) currentOverlay.setMap(null);

      const remain = station.parkingBikeTotCnt;
      const total = station.rackTotCnt;
      const available = total - remain;
      const favorites = getFavorites();
      const isFav = favorites.includes(station.stationId);

      let valueClass = 'high';
      if (remain == 0) valueClass = 'low';
      else if (remain < 5) valueClass = 'medium';

      // ì˜¤ë²„ë ˆì´ HTML êµ¬ì„±
      const content = `
        <div class="custom-overlay">
          <div class="overlay-header">
            <div class="overlay-title">${station.stationName}</div>
            <button class="fav-btn ${isFav ? 'active' : ''}" 
                    onclick="toggleFavorite('${station.stationId}')" 
                    title="ì¦ê²¨ì°¾ê¸°">
              ${isFav ? 'â˜…' : 'â˜†'}
            </button>
          </div>
          <div class="overlay-info">
            <div class="info-box">
              <div class="info-label">ëŒ€ì—¬ ê°€ëŠ¥</div>
              <div class="info-value ${valueClass}">${remain}</div>
            </div>
            <div class="info-box">
              <div class="info-label">ë°˜ë‚© ê°€ëŠ¥</div>
              <div class="info-value">${available}</div>
            </div>
          </div>
        </div>`;

      const overlay = new kakao.maps.CustomOverlay({
        content, position: marker.getPosition(), yAnchor: 1.5
      });
      overlay.setMap(map);
      currentOverlay = overlay;
      map.setCenter(marker.getPosition());
    }

    window.onload = function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(updatePosition, handleError, {
          enableHighAccuracy: true, timeout: 10000, maximumAge: 0
        });
      } else {
        alert("ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        initMap(37.5665, 126.9780);
      }
    };
  </script>
</body>
</html>