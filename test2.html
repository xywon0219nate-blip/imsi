<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ëŒ€ì—¬ì†Œ ì°¾ê¸° - FindMyRide</title>

  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet" />
  <style>
    :root {
      --main-blue: #457b9d;
      --light-blue: #a8dadc;
      --dark-blue: #1d3557;
      --bg-color: #fafafa;
      --fav-color: #e63946;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
    body { background-color: var(--bg-color); color: var(--dark-blue); }

    /* --- [ìˆ˜ì •ë¨] í—¤ë” ìŠ¤íƒ€ì¼ (Index.htmlê³¼ í†µì¼) --- */
    header {
      width: 100%;
      background: #fff;
      display: flex;
      align-items: center; /* ìˆ˜ì§ ì¤‘ì•™ */
      justify-content: space-between; /* ì–‘ë ì •ë ¬ */
      padding: 15px 30px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      position: sticky; top: 0; z-index: 1000;
    }

    .logo { 
        font-weight: 800; font-size: 1.5rem; color: var(--dark-blue); 
        text-decoration: none; z-index: 1002; margin-right: auto; 
    }

    /* ë©”ë‰´ ë¦¬ìŠ¤íŠ¸ (ì¤‘ì•™ ë°°ì¹˜) */
    .nav-links { 
        display: flex; gap: 30px; list-style: none; margin: 0; padding: 0; 
        position: absolute; left: 50%; transform: translateX(-50%);
    }
    .nav-links a { 
        text-decoration: none; color: var(--dark-blue); 
        font-weight: 600; font-size: 16px; transition: color 0.2s; 
    }
    .nav-links a:hover { color: var(--main-blue); }

    /* í–„ë²„ê±° ë©”ë‰´ (ëª¨ë°”ì¼ìš©) */
    .hamburger { 
        display: none; cursor: pointer; font-size: 24px; 
        color: var(--dark-blue); z-index: 1002; background: none; border: none; padding: 5px; 
    }

    /* --- ê²€ìƒ‰ì°½ ë””ìì¸ --- */
    .search-wrapper {
        position: absolute;
        top: 20px; left: 50%; transform: translateX(-50%);
        z-index: 100;
        width: 90%; max-width: 420px;
    }

    .search-container {
        background: #fff;
        border-radius: 50px; padding: 6px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        display: flex; align-items: center; justify-content: space-between;
        border: 2px solid transparent; transition: all 0.3s ease;
    }
    .search-container:focus-within { border-color: var(--main-blue); box-shadow: 0 6px 20px rgba(69, 123, 157, 0.2); }
    
    #keyword {
        flex: 1; border: none; background: transparent; padding: 10px 15px;
        font-size: 16px; outline: none; min-width: 0;
    }
    
    .search-btn {
        background: var(--main-blue); color: white; border: none;
        padding: 10px 24px; border-radius: 40px; cursor: pointer;
        font-weight: 700; font-size: 15px; flex-shrink: 0; margin-left: 5px;
    }
    .search-btn:hover { background: var(--dark-blue); }

    /* ì—°ê´€ ê²€ìƒ‰ì–´ ë°•ìŠ¤ */
    .suggestion-box {
        background: white; margin-top: 8px; border-radius: 20px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.15); max-height: 250px;
        overflow-y: auto; display: none; padding: 10px 0; animation: fadeIn 0.2s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .suggestion-item {
        padding: 12px 20px; border-bottom: 1px solid #f1f5f9; cursor: pointer;
        display: flex; align-items: center; font-size: 14px;
    }
    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item:hover { background-color: #f0f9ff; }
    .s-id { font-weight: bold; color: var(--main-blue); margin-right: 10px; min-width: 40px; }
    .s-name { color: #333; flex: 1; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* --- ì§€ë„ ì˜ì—­ --- */
    .hero { position: relative; height: calc(100vh - 70px); width: 100%; }
    #map { width: 100%; height: 100%; }

    .loading-message {
      position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
      background: rgba(29, 53, 87, 0.9); padding: 12px 24px;
      border-radius: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      font-size: 14px; font-weight: 600; color: white;
      z-index: 15; display: none; white-space: nowrap;
    }

    /* ì˜¤ë²„ë ˆì´ (ë§í’ì„ ) */
    .custom-overlay {
      position: relative; background: white; border-radius: 16px;
      padding: 14px 18px; box-shadow: 0 3px 14px rgba(0,0,0,0.25);
      border: 2px solid var(--main-blue); min-width: 220px;
    }
    .custom-overlay::after {
      content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
      border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 10px solid white;
    }
    .overlay-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px;
    }
    .overlay-title { font-weight: 700; color: var(--dark-blue); font-size: 15px; margin-right: 10px; }
    .fav-btn { background: none; border: none; cursor: pointer; font-size: 20px; color: #ccc; padding: 0; }
    .fav-btn.active { color: #ffc107; }
    .overlay-info { display: flex; justify-content: space-between; gap: 10px; font-size: 13px; }
    .info-box { flex: 1; background: #f6f8fa; border-radius: 10px; padding: 6px 0; text-align: center; }
    .info-label { color: #777; font-size: 12px; }
    .info-value { font-weight: 700; font-size: 18px; margin-top: 2px; }
    .info-value.low { color: #ff5252; }
    .info-value.medium { color: #ffa726; }
    .info-value.high { color: #2ecc71; }

    /* ë°˜ì‘í˜• ì²˜ë¦¬ */
    @media (max-width: 768px) {
        header { padding: 15px 20px; }
        
        .nav-links { 
            position: fixed; top: 0; right: -100%; left: auto; transform: none;
            height: 100vh; width: 250px; background-color: white; 
            flex-direction: column; align-items: flex-start;
            padding: 80px 30px; gap: 25px; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s ease-in-out; z-index: 1001;
        }
        .nav-links.active { right: 0; }
        
        .hamburger { display: block; margin-left: auto; }
        
        .search-btn { padding: 8px 18px; font-size: 14px; }
        .search-wrapper { width: 95%; }
    }
  </style>
</head>

<body>
  <header>
    <a href="Index.html" class="logo">FindMyRide</a>
    
    <ul class="nav-links" id="nav-links">
      <li><a href="Index.html">í™ˆ</a></li>
      <li><a href="test2.html" style="color:var(--main-blue);">ëŒ€ì—¬ì†Œ ì°¾ê¸°</a></li>
      <li><a href="r_map.html">ì¬í™œìš© ì§€ë„</a></li>
      <li><a href="MyPage.html">ë§ˆì´í˜ì´ì§€</a></li>
      <li><a href="Notice.html">ê³µì§€ì‚¬í•­</a></li>
    </ul>

    <button class="hamburger" onclick="toggleMenu()">â˜°</button>
  </header>

  <section class="hero">
    <div class="search-wrapper">
        <div class="search-container">
            <input type="text" id="keyword" placeholder="ì¥ì†Œ ê²€ìƒ‰ (ì˜ˆ: ê°•ë‚¨ì—­, 2301)" 
                   autocomplete="off"
                   onkeyup="checkKeyword()" onkeypress="if(event.keyCode==13) performSearch();">
            <button class="search-btn" onclick="performSearch()">ê²€ìƒ‰</button>
        </div>
        <div id="suggestion-box" class="suggestion-box"></div>
    </div>

    <div class="loading-message" id="loadingMsg" style="display:block;">ğŸ“ ë‚´ ìœ„ì¹˜ì™€ ì£¼ë³€ ë”°ë¦‰ì´ë¥¼ ì°¾ëŠ” ì¤‘...</div>
    <div id="map"></div>
  </section>

  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=dbb43de48b1358f249618a62dade6804&libraries=services"></script>

  <script>
    let map, userMarker, userCircle, currentOverlay = null;
    let ps; 
    const SEOUL_API_KEY = '55554254706e757238356a6d44556d';
    
    let stationMarkers = []; 
    let cachedStationsData = []; 
    let allStationList = []; 

    const FAV_STORAGE_KEY = 'findmyride_favorites';

    // í–„ë²„ê±° ë©”ë‰´ í† ê¸€ í•¨ìˆ˜
    function toggleMenu() {
        const nav = document.getElementById('nav-links');
        const btn = document.querySelector('.hamburger');
        nav.classList.toggle('active');
        btn.innerHTML = nav.classList.contains('active') ? "âœ•" : "â˜°";
    }

    // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ìœ„ì¹˜ í™•ì¸ ---
    window.onload = function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    initMap(lat, lng);
                },
                function(error) {
                    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ì„œìš¸ì‹œì²­ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                    initMap(37.5665, 126.9780);
                },
                { enableHighAccuracy: true, timeout: 5000 }
            );
        } else {
            alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            initMap(37.5665, 126.9780);
        }
    };

    function initMap(lat, lng) {
        const container = document.getElementById('map');
        const options = { center: new kakao.maps.LatLng(lat, lng), level: 4 };

        map = new kakao.maps.Map(container, options);
        ps = new kakao.maps.services.Places();

        // ë‚´ ìœ„ì¹˜ ë§ˆì»¤
        const userImage = new kakao.maps.MarkerImage(
            'https://cdn-icons-png.flaticon.com/512/3177/3177361.png', 
            new kakao.maps.Size(40, 40)
        );
        userMarker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(lat, lng), map: map, image: userImage, zIndex: 10
        });
        userCircle = new kakao.maps.Circle({
            center: new kakao.maps.LatLng(lat, lng),
            radius: 50, strokeWeight: 2, strokeColor: '#457b9d', strokeOpacity: 0.8, fillColor: '#a8dadc', fillOpacity: 0.3
        });
        userCircle.setMap(map);

        loadBikeStations(lat, lng);
    }

    async function loadBikeStations(centerLat, centerLng) {
        const loadingMsg = document.getElementById('loadingMsg');
        loadingMsg.innerText = "ğŸš´ ì£¼ë³€ ìì „ê±° ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...";
        loadingMsg.style.display = 'block';

        try {
            const PROXY = "https://api.allorigins.win/raw?url=";
            const apiUrl = `http://openapi.seoul.go.kr:8088/${SEOUL_API_KEY}/json/bikeList/1/1000/`;

            const response = await fetch(`${PROXY}${encodeURIComponent(apiUrl)}`);
            const data = await response.json();
            
            if(!data.rentBikeStatus) throw new Error("ë°ì´í„° ì˜¤ë¥˜");

            const stations = data.rentBikeStatus.row;
            allStationList = stations; 

            cachedStationsData = stations.map(station => {
                const distance = getDistance(centerLat, centerLng, parseFloat(station.stationLatitude), parseFloat(station.stationLongitude));
                return { ...station, distance };
            })
            .sort((a, b) => a.distance - b.distance)
            .slice(0, 15);

            refreshMapMarkers();
            loadingMsg.style.display = 'none';

        } catch (e) {
            console.error('ë¡œë“œ ì‹¤íŒ¨:', e);
            loadingMsg.textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
            setTimeout(() => (loadingMsg.style.display = 'none'), 3000);
        }
    }

    // --- ê²€ìƒ‰ ë¡œì§ ---
    function checkKeyword() {
        const keyword = document.getElementById('keyword').value.trim();
        const suggestionBox = document.getElementById('suggestion-box');
        
        if (keyword.length === 0) {
            suggestionBox.style.display = 'none';
            return;
        }

        const matches = allStationList.filter(s => {
            return s.stationName.includes(keyword) || s.stationId.includes(keyword);
        }).slice(0, 5); 

        if (matches.length > 0) {
            let html = '';
            matches.forEach(s => {
                html += `
                    <div class="suggestion-item" onclick="moveToStation('${s.stationLatitude}', '${s.stationLongitude}', '${s.stationName}')">
                        <span class="s-id">ğŸš²</span>
                        <span class="s-name">${s.stationName}</span>
                    </div>
                `;
            });
            suggestionBox.innerHTML = html;
            suggestionBox.style.display = 'block';
        } else {
            suggestionBox.style.display = 'none';
        }
    }

    function moveToStation(lat, lng, name) {
        const targetLat = parseFloat(lat);
        const targetLng = parseFloat(lng);
        
        const moveLatLon = new kakao.maps.LatLng(targetLat, targetLng);
        map.setCenter(moveLatLon);
        map.setLevel(3); 

        document.getElementById('keyword').value = name;
        document.getElementById('suggestion-box').style.display = 'none';

        loadBikeStations(targetLat, targetLng);
    }

    function performSearch() {
        const keyword = document.getElementById('keyword').value.trim();
        document.getElementById('suggestion-box').style.display = 'none';

        if (!keyword) {
            alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }

        ps.keywordSearch(keyword, function(data, status, pagination) {
            if (status === kakao.maps.services.Status.OK) {
                const targetLat = data[0].y;
                const targetLng = data[0].x;
                
                const moveLatLon = new kakao.maps.LatLng(targetLat, targetLng);
                map.setCenter(moveLatLon);
                map.setLevel(4);
                
                loadBikeStations(targetLat, targetLng);
            } else {
                alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    // --- ìœ í‹¸ë¦¬í‹° ---
    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 6371e3;
      const toRad = deg => deg * (Math.PI / 180);
      const Ï†1 = toRad(lat1); const Ï†2 = toRad(lat2);
      const Î”Ï† = toRad(lat2 - lat1); const Î”Î» = toRad(lng2 - lng1);
      const a = Math.sin(Î”Ï† / 2) ** 2 + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î» / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function refreshMapMarkers() {
        stationMarkers.forEach(m => m.setMap(null));
        stationMarkers = [];
        if (currentOverlay) currentOverlay.setMap(null);
        cachedStationsData.forEach(station => createStationMarker(station));
    }

    function createStationMarker(station) {
      const pos = new kakao.maps.LatLng(station.stationLatitude, station.stationLongitude);
      const favorites = getFavorites();
      const isFav = favorites.includes(station.stationId);
      const iconUrl = isFav ? "https://cdn-icons-png.flaticon.com/512/2776/2776063.png" : "https://cdn-icons-png.flaticon.com/512/2776/2776067.png";
      const markerImage = new kakao.maps.MarkerImage(iconUrl, new kakao.maps.Size(34, 34));
      const marker = new kakao.maps.Marker({ position: pos, map, image: markerImage });
      kakao.maps.event.addListener(marker, 'click', () => showStationInfo(station, marker));
      stationMarkers.push(marker);
    }

    function showStationInfo(station, marker) {
      if (currentOverlay) currentOverlay.setMap(null);
      const remain = parseInt(station.parkingBikeTotCnt);
      const total = parseInt(station.rackTotCnt);
      const favorites = getFavorites();
      const isFav = favorites.includes(station.stationId);
      let valueClass = remain == 0 ? 'low' : (remain < 3 ? 'medium' : 'high');

      const content = `
        <div class="custom-overlay">
          <div class="overlay-header">
            <div class="overlay-title">${station.stationName}</div>
            <button class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFavorite('${station.stationId}')">${isFav ? 'â˜…' : 'â˜†'}</button>
          </div>
          <div class="overlay-info">
            <div class="info-box"><div class="info-label">ëŒ€ì—¬ ê°€ëŠ¥</div><div class="info-value ${valueClass}">${remain}</div></div>
            <div class="info-box"><div class="info-label">ê±°ì¹˜ëŒ€ ìˆ˜</div><div class="info-value">${total}</div></div>
          </div>
        </div>`;
      const overlay = new kakao.maps.CustomOverlay({ content, position: marker.getPosition(), yAnchor: 1.4 });
      overlay.setMap(map);
      currentOverlay = overlay;
      map.panTo(marker.getPosition());
    }

    function getFavorites() {
        const stored = localStorage.getItem(FAV_STORAGE_KEY);
        return stored ? JSON.parse(stored) : [];
    }
    function saveFavorites(favArray) {
        localStorage.setItem(FAV_STORAGE_KEY, JSON.stringify(favArray));
    }
    function toggleFavorite(stationId) {
        let favorites = getFavorites();
        if (favorites.includes(stationId)) {
            favorites = favorites.filter(id => id !== stationId);
        } else {
            favorites.push(stationId);
        }
        saveFavorites(favorites);
        refreshMapMarkers(); 
    }
  </script>
</body>
</html>
